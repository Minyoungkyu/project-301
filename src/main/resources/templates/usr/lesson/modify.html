<html layout:decorate="~{usr/common/layout}">

<head>
    <title th:text="|강의 - ${lecture.subject}|"></title>
</head>

<body>



<div class="flex-1 flex items-center justify-center" layout:fragment="content">
    <th:block th:replace="common/fragments :: toastuiEidtorLib"></th:block>

    <div class="container w-full px-4">
        <h1 class="my-4">
            <i class="fa-regular fa-file-word"></i>
            <span th:text="|${lecture.subject} 커리큘럼|"></span>
        </h1>

        <form class="flex flex-col gap-6" method="POST" enctype="multipart/form-data"
              onsubmit="submitModifyForm(this); return false;"
              th:action>
            <div class="card bg-base-100 shadow-xl " th:if="${lecture.lessonsReady}" >
                <div class="card-body">
                    <div class="detail grid grid-rows-[repeat(auto-fit,minmax(70px,1fr))] gap-3">
                        <div th:each="lesson : ${lessons}" class="text-left">
                            <span class="btn btn-active btn-neutral" th:text="|${lesson.sortNo} 강 |"></span>
                            <a th:href="|/usr/lesson/hls/${lesson.id}|" class="text-left btn btn-outline w-[300px]"
                               th:text="${lesson.subject}">
                            </a>
                            <span class="btn btn-active btn-neutral" th:text="${lesson.lessonLengthForPrint}"></span>

                            <button type="button" class="btn btn-sm btn-primary" th:onclick="'modifyFormModal'+${lesson.id}+'.showModal()'">
                                수업 수정하기
                            </button>

                            <dialog th:id="'modifyFormModal' + ${lesson.id}" class="modal">
                                <div class="modal-box">
                                    <div class="form-control col-span-full">
                                        <label class="label">
                                            <span class="label-text">수업 제목 변경</span>
                                        </label>

                                        <div class="flex items-center">
                                            <input class="input input-bordered w-full" maxlength="100"
                                                   name="subject" placeholder="제목" type="text" th:value="${lesson.subject}"
                                                   th:data-original="${lesson.subject}">
                                        </div>
                                    </div>

                                    <ul class="mt-16 list-disc mx-5 text-gray-400">
                                        <li>
                                            강의 영상 변경을 위해 체크와 파일선택이 동시에 이루어져야 합니다.
                                        </li>
                                        <li>
                                            파일선택시 취소를 선택하면 파일선택을 리셋할 수 있습니다.
                                        </li>
                                    </ul>
                                    <div class="form-control col-span-full">
                                        <label class="label">
                                            <span class="label-text">기존 강의영상 삭제</span>
                                        </label>

                                        <div class="flex items-center gap-3">
                                            <input type="checkbox" class="checkbox" name="videoRemove" value="true">

                                        </div>
                                    </div>

                                    <div class="form-control">
                                        <label class="label">
                                            <span class="label-text">새 강의영상 </span>
                                        </label>
                                        <input class="file-input file-input-bordered"
                                               name="video"
                                               type="file">
                                    </div>

                                    <div class="flex flex-row justify-between mt-12">
                                        <form method="dialog">
                                            <button type="button" class="btn btn-error" onclick="closeAndReset(this);">취소</button>
                                        </form>
                                        <form method="dialog">
                                            <button type="button" class="btn btn-primary" onclick="saveChanges(this);">저장</button>
                                        </form>
                                    </div>


                                </div>
                            </dialog>

                            <ul class="hidden mt-4 list-disc mx-5 text-gray-400">
                                <li >
                                    <span>바꿀 제목 : </span><span id="currentValue1"></span>
                                </li>
                                <li>
                                    <span>영상 변경 : </span><span id="currentValue2"></span>
                                </li>
                            </ul>

                        </div>
                    </div>

                    <script>

                        function closeAndReset(buttonElement) {
                            // 현재 다이얼로그를 닫음
                            buttonElement.closest('dialog').close();

                            // 현재 다이얼로그 내의 모든 input 요소의 값을 리셋
                            let dialog = buttonElement.closest('dialog');
                            let inputs = dialog.querySelectorAll('input:not([name=subject])'); // subject를 제외한 input
                            inputs.forEach(input => {
                                input.value = '';
                                if(input.type === 'checkbox') {
                                    input.checked = false;
                                }
                            });

                            // subject 입력값을 원래 값으로 되돌림
                            let subjectInput = dialog.querySelector('input[name=subject]');
                            if(subjectInput) {
                                subjectInput.value = subjectInput.dataset.original;
                            }

                            // 현재 button 이 속한 dialog 의 형제 ul 의 클래스에 hidden 추가
                            let ulElement = dialog.nextElementSibling;
                                if (ulElement && ulElement.tagName === 'UL') {
                                    ulElement.classList.add('hidden');
                                }
                        }

                        function saveChanges(buttonElement) {

                            // 1. 현재 button이 속한 dialog의 형제인 ul 태그의 클래스 중 hidden을 제거
                            let dialogElement = buttonElement.closest('dialog');
                            let ulElement = dialogElement.nextElementSibling;
                            if (ulElement.tagName === 'UL') {
                                ulElement.classList.remove('hidden');
                            }

                            // 2. 현재 button이 속한 dialog의 input 중 name이 subject인 input의 현재 입력값을 ul의 currentValue1 span에 부여
                            let subjectInputValue = dialogElement.querySelector('input[name="subject"]').value;
                            let currentValue1Span = ulElement.querySelector('span#currentValue1');
                            currentValue1Span.textContent = subjectInputValue;

                            // 3. 현재 button이 속한 dialog의 input 중 checkbox의 상태에 따라 값을 부여
                            let checkbox = dialogElement.querySelector('input[type="checkbox"]');
                            let currentValue2Span = ulElement.querySelector('span#currentValue2');
                            if (checkbox.checked) {
                                currentValue2Span.textContent = '변경 예정';
                            } else {
                                currentValue2Span.textContent = '변경 안함';
                            }

                            // 4. 현재 button이 속한 dialog를 닫음
                            dialogElement.close();
                        }
                    </script>


                    <div class="">
                        <button class="btn btn-block btn-primary gap-1 mt-24">
                            <i class="fa-solid fa-pen"></i>
                            <span>강의 등록</span>
                        </button>
                    </div>
                </div>
            </div>
        </form>

        <div id="loadingOverlay" style="display:none;" class="fixed top-0 left-0 w-full h-full bg-white bg-opacity-80 z-50">
            <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2">

                <p>동영상이 업로드 중 입니다. 잠시만 기다려주세요.</p>

                <br>

                <progress class="progress" style="width:360px;"></progress>

                <br>

                <ul class="mt-4 list-disc mx-5 text-gray-400">
                    <li>
                        동영상 업로드가 완료되면 페이지가 이동 됩니다.
                    </li>
                    <li>
                        동영상의 양에 따라 몇 분의 시간이 걸릴 수 있습니다.
                    </li>

                    <br>

                    <li>
                        업로드가 완료되면 동영상의 변환작이 시작됩니다.
                    </li>
                    <li>
                        동영상 변환이 진행되는 동안은 작성을 완료한 커리큘럼이라도 노출이 되지 않습니다.
                    </li>
                    <li>
                        동영상 변환이 완료되면 작성하신 커리큘럼을 확인하실 수 있습니다.
                    </li>


                </ul>


            </div>
        </div>

        <script>
            let submitModifyFormDone = false;

            function submitModifyForm(form) {

                if (submitModifyFormDone) return;

                let checkboxes = form.elements.namedItem("videoRemove");
                if (!checkboxes.length) {
                    checkboxes = [checkboxes];
                }

                let fileInputs = form.elements.namedItem("video");
                if (!fileInputs.length) {
                    fileInputs = [fileInputs];
                }

                let checkedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
                let fileSelectedCount = Array.from(fileInputs).filter(input => input.files.length > 0).length;

                console.log(checkedCount);
                console.log(fileSelectedCount);

                if (checkedCount !== fileSelectedCount) {
                    toastWarning('영상 변경 요청이 올바르지 않습니다. 삭제 체크와 파일 선택이 동일하게 선택되었는지 확인해주세요.');
                    return;
                }

                function showLoadingOverlay() {
                    document.getElementById('loadingOverlay').style.display = 'block';
                }

                // "비디오 업로드 중..." 알림 표시 (여기서는 단순한 alert를 사용했으나, 실제로는 보다 나은 UX를 위한 로딩 애니메이션 등을 사용할 수 있습니다.)
                showLoadingOverlay();

                // FormData 객체를 사용하여 form의 데이터를 가져옵니다.
                let formData = new FormData(form);

                // fetch를 사용하여 비동기 요청을 보냅니다.
                fetch(form.action, {
                    method: 'POST',
                    body: formData
                })
                .then(res => res.json()) // 응답을 JSON 형태로 파싱합니다.
                .then(rs => {
                    // 요청 성공 시 수행할 로직 (예: 페이지 리디렉션)
                    if (rs.success) {
                        let lectureId = rs.data;
                        window.location.href = `/usr/lecture/detail/${lectureId}`;
                    }
                })

                submitModifyFormDone = true;
            }
        </script>

    </div>

</div>

</body>

</html>